<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisme Sales - CRM</title>
    
    <!-- INÍCIO: Tags para PWA e Ícones Personalizados -->
    <meta name="theme-color" content="#2fc36a">
    
    <!-- Favicons para Navegadores (CORRIGIDO) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.ico">

    <!-- Ícone para "Adicionar à Tela de Início" no iOS (CORRIGIDO) -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/apple-touch-icon.png">

    <!-- Manifesto do PWA -->
    <link rel="manifest" id="manifest">
    <!-- FIM: Tags para PWA e Ícones Personalizados -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        /* --- ESTILOS GERAIS E MELHORIAS DE LAYOUT --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Impede o scroll da página inteira */
            background-color: #f8fafc; /* slate-50 */
        }
        .kanban-board-container::-webkit-scrollbar { height: 8px; }
        .kanban-board-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .kanban-board-container::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 4px; }
        
        /* --- ESTILOS DO QUADRO KANBAN (ESTILO TRELLO) --- */
        #kanban-board {
            height: calc(100vh - 73px); /* Altura do header em desktop */
            overflow-x: auto; /* Garante o scroll horizontal */
            overflow-y: hidden; /* Previne o scroll vertical no quadro */
        }
        @media (max-width: 767px) {
            #kanban-board {
                height: calc(100vh - 125px); /* Altura do header em mobile */
            }
        }
        .kanban-column {
            height: 100%; /* Colunas ocupam toda a altura do board */
            display: flex;
            flex-direction: column;
        }
        .kanban-cards {
            flex-grow: 1; /* Faz a área dos cards ocupar o espaço restante */
            overflow-y: auto; /* Habilita o scroll vertical DENTRO da coluna */
            padding-right: 4px; /* Espaço para a barra de rolagem */
            scrollbar-width: none; /* Firefox */
        }
        .kanban-cards::-webkit-scrollbar { 
            display: none; /* Chrome, Safari, and Opera */
        }

        /* --- ESTILOS DO MODAL --- */
        #task-list-container, #ticket-list-container {
            max-height: 45vh; /* Define uma altura máxima para a lista */
            overflow-y: auto; /* Adiciona scroll apenas na lista quando necessário */
        }
        #task-list-container::-webkit-scrollbar, #ticket-list-container::-webkit-scrollbar { width: 6px; }
        #task-list-container::-webkit-scrollbar-track, #ticket-list-container::-webkit-scrollbar-track { background: #e2e8f0; }
        #task-list-container::-webkit-scrollbar-thumb, #ticket-list-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .tab-badge {
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
        }

        /* --- ESTILOS DO FILTRO E MENU DE USUÁRIO --- */
        .popup-menu {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .popup-menu.hidden {
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .filter-tag-option {
            transition: background-color 0.2s;
        }
        .filter-tag-option:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        
        /* UPGRADE: Estilo para a nova visão de lista */
        .list-item-row { transition: background-color 0.2s, border-color 0.2s; }
        .list-item-row:hover {
            background-color: #f8fafc; /* slate-50 */
        }

        /* --- OUTROS ESTILOS --- */
        .kanban-card { user-select: none; }
        .kanban-column.collapsed { width: 56px; cursor: pointer; }
        .kanban-column.collapsed .column-header-expanded, .kanban-column.collapsed .kanban-cards { display: none; }
        .kanban-column.collapsed .column-header-collapsed { display: flex; }
        .kanban-column .column-header-collapsed .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; padding: 16px 0; }
        .form-input { margin-top: 4px; display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #d4d4d8; padding: 0.5rem 0.75rem; background-color: #fafafa; }
        .form-input:focus { border-color: #16a34a; outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #a7f3d0; }
        .ql-editor { min-height: 150px; }
        .tab-button { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #737373; }
        .tab-button.active { border-color: #2fc36a; color: #15803d; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .suggestion-btn { background-color: #f4f4f5; color: #52525b; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; transition: background-color 0.2s; }
        .suggestion-btn:hover { background-color: #e4e4e7; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } }
        .pulse-animation { animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="font-sans h-full">

    <!-- Ecrã de Login -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-slate-100 p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <img src="https://crm.prismeapp.com.br/web/binary/company_logo" alt="Logo Prisme Sales" class="mx-auto h-20 w-auto" onerror="this.style.display='none'">
                <h2 class="mt-6 text-3xl font-bold text-gray-900">Prisme Sales - CRM</h2>
                <p class="text-gray-500">Faça login para continuar</p>
            </div>
            <div id="login-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
            <form id="login-form" class="space-y-4">
                <div><label for="email" class="text-sm font-medium text-gray-700">Email</label><input id="email" type="email" required class="form-input" placeholder="seu.email@prismeapp.com.br"></div>
                <div><label for="telefone" class="text-sm font-medium text-gray-700">Sua senha</label><input id="telefone" type="password" required class="form-input" placeholder="••••••••"></div>
                <div><button type="submit" class="w-full px-4 py-2 text-lg font-semibold text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b] transition-colors">Entrar</button></div>
                <div>
                    <button type="button" id="install-pwa-login-button" class="hidden w-full px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Instalar App
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ecrã de Carregamento -->
    <div id="loading-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-100 z-50">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-600 z-10 pulse-animation">Preparando tudo para você relacionar mais!</h2>
    </div>

    <!-- Aplicação Principal -->
    <div id="crm-app" class="hidden h-full flex flex-col">
        <header class="bg-white p-4 flex flex-wrap gap-4 justify-between items-center border-b border-slate-200 flex-shrink-0">
            <!-- Logo e Título -->
            <div class="flex items-center space-x-3">
                <img src="https://crm.prismeapp.com.br/web/binary/company_logo" alt="Logo Prisme Sales" class="h-8 w-auto" onerror="this.style.display='none'">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Seu CRM</h1>
            </div>
            
            <!-- Controles Centrais (Pesquisa e Filtro) -->
            <div class="w-full md:w-auto md:flex-1 flex justify-center px-0 md:px-4 order-3 md:order-2">
                <div class="flex items-center gap-2 w-full max-w-lg">
                    <!-- Filtro de Tags -->
                    <div id="filter-container" class="relative flex-shrink-0">
                         <button id="filter-trigger-btn" data-active-tag-id="" class="flex items-center justify-center w-full px-4 py-2 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                             <span id="filter-btn-text">TODOS</span>
                             <i class="fas fa-chevron-down ml-2 text-xs text-gray-500"></i>
                         </button>
                         <div id="filter-popup" class="hidden popup-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                             <div id="filter-options-container" class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                 <!-- Opções de filtro serão inseridas aqui -->
                             </div>
                         </div>
                    </div>
                    <!-- Barra de Pesquisa -->
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="search" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-400 focus:border-green-400" placeholder="Pesquisar por empresa...">
                    </div>
                    <!-- UPGRADE: Botão de alternância de visualização -->
                    <button id="view-toggle-btn" class="flex-shrink-0 flex items-center justify-center w-11 h-11 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors" title="Alternar para Visão de Lista">
                        <i id="view-toggle-icon" class="fas fa-list-check text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Controles do Usuário -->
            <div class="flex items-center space-x-4 justify-end order-2 md:order-3">
                <button id="install-pwa-header-button" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-3 rounded-full" title="Instalar App">
                    <i class="fas fa-download"></i>
                </button>
                <!-- Menu de Usuário -->
                <div id="user-menu-container" class="relative">
                    <button id="user-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 overflow-hidden">
                        <!-- User initial or image will be inserted here -->
                    </button>
                    <div id="logout-popup" class="hidden popup-menu absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20">
                        <div class="py-1">
                            <div class="px-4 py-2 border-b">
                                <p id="popup-user-name" class="text-sm font-semibold text-gray-900 truncate"></p>
                                <p id="popup-user-email" class="text-sm text-gray-500 truncate"></p>
                            </div>
                            <a href="#" id="popup-logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="kanban-board" class="kanban-board-container flex space-x-4 p-4 flex-grow"></main>

        <!-- UPGRADE: Nova Visão de Lista -->
        <div id="list-view" class="hidden flex-grow flex flex-col">
            <!-- Filtros da Lista -->
            <div id="list-view-filters" class="p-4 bg-white border-b border-slate-200 flex-shrink-0 flex flex-wrap gap-4 items-center">
                <span class="font-semibold text-gray-700 hidden md:inline">Filtros da Lista:</span>
                <!-- Filtro de Tipo -->
                <div class="relative">
                    <select id="list-filter-type" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                        <option value="all">Todos os Tipos</option>
                        <option value="task">Apenas Tarefas</option>
                        <option value="ticket">Apenas Tickets</option>
                    </select>
                </div>
                <!-- Filtro de Responsável -->
                <div class="relative">
                    <select id="list-filter-responsible" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                        <!-- Opções de usuários serão inseridas aqui -->
                    </select>
                </div>
            </div>
            <!-- Container da Lista de Atividades -->
            <div id="list-view-container" class="overflow-y-auto flex-grow p-4">
                <!-- Itens da lista serão inseridos aqui -->
            </div>
        </div>

    </div>

    <!-- Modal do Cliente -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-20">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0"></div>
    </div>
    
    <!-- NOVO MODAL: Editor de Tarefa/Ticket -->
    <div id="item-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30">
        <div id="item-editor-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <!-- Conteúdo do editor será injetado aqui -->
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="confirm-action-btn" class="px-6 py-2 rounded-full text-white bg-red-500 hover:bg-red-600 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>
    
    <template id="loader-template"><div class="flex items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div></template>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 z-40"></div>

    <script>
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxR0sTr_AXocdDTGBRrQPYA1DHoiA6JNUZcyjvhWl_SymcG5leJxbBC6gq5-jzIyP3bQA/exec';
        const CARDS_TO_SHOW_INITIAL = 30;
        const CARDS_TO_LOAD_MORE = 15;

        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const crmApp = document.getElementById('crm-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const kanbanBoard = document.getElementById('kanban-board');
        const clientModal = document.getElementById('client-modal');
        const modalContent = document.getElementById('modal-content');
        const searchInput = document.getElementById('search-input');
        const loaderTemplate = document.getElementById('loader-template');
        const toast = document.getElementById('toast');
        let appData = {};
        let quillEditor = null; // Editor principal no modal do cliente
        let itemQuillEditor = null; // Editor secundário no novo modal de item
        let currentUser = null;
        let deferredPrompt;
        let activeTagId = null;

        // UPGRADE: Variáveis de estado para a nova visão
        let currentView = 'kanban'; // 'kanban' ou 'list'
        let listFilterType = 'all';
        let listFilterResponsibleId = 'all';
        const listView = document.getElementById('list-view');
        const viewToggleButton = document.getElementById('view-toggle-btn');
        const viewToggleIcon = document.getElementById('view-toggle-icon');

        // --- FUNÇÕES DE UTILIDADE ---
        function jsonpRequest(url, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(null, data);
            };
            const script = document.createElement('script');
            script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
            script.onerror = () => callback(new Error('Falha ao carregar o script JSONP.'), null);
            document.body.appendChild(script);
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        // --- LÓGICA DE CONFIRMAÇÃO ---
        function showConfirmationModal(message, onConfirm) {
            const confirmationModal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-action-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            messageEl.textContent = message;

            const confirmHandler = () => {
                onConfirm();
                hideConfirmationModal();
            };

            const cancelHandler = () => {
                hideConfirmationModal();
            };
            
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));

            document.getElementById('confirm-action-btn').addEventListener('click', confirmHandler);
            document.getElementById('confirm-cancel-btn').addEventListener('click', cancelHandler);

            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }


        // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
        function showApp(isInitialLoad = false) {
            if (isInitialLoad) {
                loginScreen.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
            }
            
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            userAvatarBtn.innerHTML = '';
            const userInitial = currentUser.NomeUsuario ? currentUser.NomeUsuario.charAt(0).toUpperCase() : '?';
            
            const fallback = document.createElement('span');
            fallback.className = 'text-lg';
            fallback.textContent = userInitial;

            if (currentUser.FotoURL) {
                const img = document.createElement('img');
                img.src = currentUser.FotoURL;
                img.crossOrigin = "anonymous";
                img.referrerPolicy = "no-referrer";
                img.className = 'w-full h-full rounded-full object-cover';
                img.alt = 'Avatar';
                img.onerror = () => {
                    userAvatarBtn.innerHTML = '';
                    userAvatarBtn.appendChild(fallback);
                };
                userAvatarBtn.appendChild(img);
            } else {
                userAvatarBtn.appendChild(fallback);
            }
            
            document.getElementById('popup-user-name').textContent = currentUser.NomeUsuario;
            document.getElementById('popup-user-email').textContent = currentUser.Email;
            
            initializeApp();
        }

        function showLogin() {
            localStorage.removeItem('crmUser');
            currentUser = null;
            crmApp.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            const loginUrl = `${SCRIPT_URL}?action=loginUser&email=${encodeURIComponent(email)}&telefone=${encodeURIComponent(telefone)}`;
            jsonpRequest(loginUrl, (err, data) => {
                if (err || !data.success) {
                    loginError.textContent = err ? err.message : data.message;
                    loginError.classList.remove('hidden');
                } else {
                    currentUser = data.user;
                    localStorage.setItem('crmUser', JSON.stringify(currentUser));
                    showApp(true);
                }
            });
        });

        function initializeApp() {
            jsonpRequest(`${SCRIPT_URL}?action=getData`, (err, data) => {
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');

                if (err || data.success === false) {
                    const msg = err ? err.message : data.message;
                    kanbanBoard.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><b>Erro:</b> ${msg}</div>`;
                    return;
                }
                appData = data;
                setupFilterLogic();
                setupUserMenu();
                // UPGRADE: Adicionar listener para o novo botão de visualização
                setupViewToggle();
                applyFiltersAndRender();
            });
        }

        // --- LÓGICA DE FILTRAGEM E RENDERIZAÇÃO ---
        function getFilteredClients() {
            let filteredClients = appData.clients;

            if (activeTagId) {
                const clientIdsWithTag = appData.clientTags
                    .filter(ct => ct.ID_Tag === activeTagId)
                    .map(ct => ct.ID_Cliente);
                
                filteredClients = appData.clients.filter(client => clientIdsWithTag.includes(client.ID_Cliente));
            }

            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm.length >= 3) {
                filteredClients = filteredClients.filter(client => 
                    client.NomeEmpresa.toLowerCase().includes(searchTerm)
                );
            }
            return filteredClients;
        }

        // UPGRADE: Função principal de renderização agora decide qual view mostrar
        function applyFiltersAndRender() {
            if (currentView === 'kanban') {
                const clientList = getFilteredClients();
                renderBoard(clientList);
            } else {
                renderListView();
            }
        }

        function setupFilterLogic() {
            const filterContainer = document.getElementById('filter-container');
            const triggerBtn = document.getElementById('filter-trigger-btn');
            const popup = document.getElementById('filter-popup');
            const optionsContainer = document.getElementById('filter-options-container');
            const btnText = document.getElementById('filter-btn-text');

            optionsContainer.innerHTML = ''; // Limpa opções antigas

            if (appData.tags) {
                appData.tags.forEach(tag => {
                    const option = document.createElement('a');
                    option.href = '#';
                    option.className = 'filter-tag-option text-gray-700 block px-4 py-2 text-sm';
                    option.dataset.tagId = tag.ID_Tag;
                    option.dataset.tagName = tag.NomeTag;
                    option.dataset.tagColor = tag.Cor;
                    
                    option.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-3" style="background-color: ${tag.Cor};"></span>
                            <span>${tag.NomeTag}</span>
                        </div>
                    `;

                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.currentTarget;
                        activeTagId = target.dataset.tagId;

                        btnText.textContent = target.dataset.tagName;
                        triggerBtn.style.backgroundColor = `${target.dataset.tagColor}20`;
                        triggerBtn.style.color = target.dataset.tagColor;
                        triggerBtn.style.borderColor = target.dataset.tagColor;
                        triggerBtn.dataset.activeTagId = activeTagId;

                        popup.classList.add('hidden');
                        applyFiltersAndRender();
                    });
                    optionsContainer.appendChild(option);
                });
            }

            triggerBtn.addEventListener('click', () => {
                if (triggerBtn.dataset.activeTagId) {
                    activeTagId = null;
                    triggerBtn.dataset.activeTagId = '';
                    btnText.textContent = 'TODOS';
                    triggerBtn.style.backgroundColor = 'white';
                    triggerBtn.style.color = '#374151';
                    triggerBtn.style.borderColor = '#D1D5DB';
                    applyFiltersAndRender();
                } else {
                    popup.classList.toggle('hidden');
                }
            });
        }
        
        function setupUserMenu() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            const logoutPopup = document.getElementById('logout-popup');
            const popupLogoutBtn = document.getElementById('popup-logout-btn');

            userAvatarBtn.addEventListener('click', () => {
                logoutPopup.classList.toggle('hidden');
            });

            popupLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logoutPopup.classList.add('hidden');
                showLogin();
            });

            document.addEventListener('click', (e) => {
                if (!userMenuContainer.contains(e.target)) {
                    logoutPopup.classList.add('hidden');
                }
                 if (!document.getElementById('filter-container').contains(e.target)) {
                     document.getElementById('filter-popup').classList.add('hidden');
                 }
            });
        }

        searchInput.addEventListener('input', applyFiltersAndRender);

        // --- RENDERIZAÇÃO DO QUADRO KANBAN ---
        function renderBoard(clientList = []) {
            kanbanBoard.innerHTML = '';
            appData.statuses.sort((a, b) => a.Ordem - b.Ordem).forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column bg-slate-100 rounded-lg p-3 w-[90vw] md:w-80 flex-shrink-0 transition-all duration-300';
                const clientsInStatus = clientList.filter(c => c.Status === status.NomeStatus);
                
                const initialClients = clientsInStatus.slice(0, CARDS_TO_SHOW_INITIAL);

                column.innerHTML = `
                    <div class="column-header-expanded flex justify-between items-center mb-3 flex-shrink-0">
                        <div class="flex items-center min-w-0"><h2 class="font-bold text-gray-700 truncate">${status.NomeStatus}</h2><span class="ml-2 bg-slate-200 text-slate-600 text-sm font-semibold rounded-full px-2">${clientsInStatus.length}</span></div>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600"><i class="fa-solid fa-angles-left"></i></button>
                    </div>
                    <div class="column-header-collapsed hidden flex-col items-center justify-between h-full flex-shrink-0">
                        <div class="vertical-text font-bold text-gray-700">${status.NomeStatus}</div><span class="bg-slate-200 text-slate-600 text-sm font-semibold rounded-full w-6 h-6 flex items-center justify-center mb-2">${clientsInStatus.length}</span>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600"><i class="fa-solid fa-angles-left"></i></button>
                    </div>
                    <div class="kanban-cards min-h-[100px]" data-status-name="${status.NomeStatus}"></div>`;
                
                const cardsContainer = column.querySelector('.kanban-cards');
                
                initialClients.forEach(client => cardsContainer.appendChild(createClientCard(client)));
                
                kanbanBoard.appendChild(column);

                if (clientsInStatus.length > CARDS_TO_SHOW_INITIAL) {
                    attachLazyLoad(cardsContainer, clientsInStatus);
                }
            });
            initializeDragAndDrop();
            initializeColumnControls();
        }

        function attachLazyLoad(container, allClients) {
            let renderedCount = container.children.length;
            container.addEventListener('scroll', () => {
                if (container.dataset.loading === 'true') return;
                if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                    if (renderedCount < allClients.length) {
                        container.dataset.loading = 'true';
                        const nextBatch = allClients.slice(renderedCount, renderedCount + CARDS_TO_LOAD_MORE);
                        nextBatch.forEach(client => container.appendChild(createClientCard(client)));
                        renderedCount += nextBatch.length;
                        setTimeout(() => { container.dataset.loading = 'false'; }, 100);
                    }
                }
            });
        }
        
        function initializeColumnControls() {
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.kanban-column').classList.toggle('collapsed'); });
            });
            document.querySelectorAll('.kanban-column').forEach(column => {
                column.addEventListener('click', (e) => { if(column.classList.contains('collapsed')) { column.classList.remove('collapsed'); } })
            })
        }

        function formatTimeRemaining(dueDateString) {
            if (!dueDateString) return { text: 'Sem prazo', colorClass: 'text-gray-500', pulse: false };
            const dueDate = new Date(dueDateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(23, 59, 59, 999); // Considera o dia todo do prazo
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: 'Atrasado', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays === 0) return { text: 'Hoje', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 3) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 7) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-yellow-600 font-semibold', pulse: false };
            return { text: `Faltam ${diffDays} dias`, colorClass: 'text-gray-500', pulse: false };
        }

        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'kanban-card bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-green-400 hover:shadow-md cursor-pointer transition-all';
            card.dataset.clientId = client.ID_Cliente;

            const clientTags = (appData.clientTags || []).filter(ct => ct.ID_Cliente === client.ID_Cliente).map(ct => (appData.tags || []).find(t => t.ID_Tag === ct.ID_Tag)).filter(Boolean);
            const tagsHtml = clientTags.map(tag => `<span class="text-xs font-medium mr-1 mb-1 px-2 py-0.5 rounded-full" style="background-color:${tag.Cor}20; color:${tag.Cor};">${tag.NomeTag}</span>`).join('');
            
            const progress = calculateProgress(client.ID_Cliente);

            const clientTasks = appData.tasks ? appData.tasks.filter(t => t.ID_Cliente === client.ID_Cliente && !t.Concluido && t.PrazoFinal) : [];
            clientTasks.sort((a, b) => new Date(a.PrazoFinal) - new Date(b.PrazoFinal));
            const nextTask = clientTasks[0];

            let nextTaskHtml;
            
            if (nextTask) {
                const timeInfo = formatTimeRemaining(nextTask.PrazoFinal);
                nextTaskHtml = `
                    <div class="mt-3 pt-3 border-t border-gray-100 group relative cursor-pointer" data-task-id="${nextTask.ID_Tarefa}">
                        <div class="absolute inset-0 bg-green-100 opacity-0 group-hover:opacity-100 transition-opacity rounded-md hidden md:flex items-center justify-center">
                            <span class="text-green-700 font-bold"><i class="fas fa-check mr-2"></i>Marcar como concluída?</span>
                        </div>
                        <p class="text-xs text-gray-400 font-semibold uppercase">Próxima Tarefa</p>
                        <div class="flex items-center justify-between mt-2">
                            <div class="break-words w-full pr-2">
                                <span class="text-sm text-gray-700 font-medium">${nextTask.TituloTarefa}</span>
                                <p class="text-sm mt-1 ${timeInfo.colorClass} ${timeInfo.pulse ? 'pulse-animation' : ''}">${timeInfo.text}</p>
                            </div>
                            <div class="user-avatar-placeholder w-8 h-8 flex-shrink-0"></div>
                        </div>
                    </div>
                `;
            } else {
                nextTaskHtml = `<div class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-100">Nenhuma tarefa pendente com prazo.</div>`;
            }

            card.innerHTML = `
                <h3 class="font-semibold text-gray-800 truncate">${client.NomeEmpresa}</h3>
                <p class="text-sm text-gray-500 mb-3"><i class="fas fa-user mr-2 text-gray-400"></i>${client.NomeResponsavel}</p>
                <div class="flex flex-wrap gap-y-1 mb-3">${tagsHtml}</div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${progress}%"></div></div>
                ${nextTaskHtml}
            `;

            // Programmatically create and append avatar to avoid innerHTML issues
            const avatarPlaceholder = card.querySelector('.user-avatar-placeholder');
            if (avatarPlaceholder && nextTask) {
                const responsibleUser = appData.users.find(u => u.ID_Usuario === nextTask.Responsavel_ID);
                
                if (responsibleUser) {
                    const userInitial = responsibleUser.NomeUsuario ? responsibleUser.NomeUsuario.charAt(0).toUpperCase() : '?';
                    
                    const fallbackAvatar = document.createElement('div');
                    fallbackAvatar.className = 'w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold';
                    fallbackAvatar.title = responsibleUser.NomeUsuario;
                    fallbackAvatar.textContent = userInitial;

                    if (responsibleUser.FotoURL) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = responsibleUser.FotoURL;
                        avatarImg.crossOrigin = "anonymous";
                        avatarImg.referrerPolicy = "no-referrer";
                        avatarImg.className = 'w-8 h-8 rounded-full flex-shrink-0 object-cover';
                        avatarImg.title = responsibleUser.NomeUsuario;
                        avatarImg.onerror = () => {
                            avatarPlaceholder.innerHTML = ''; // Clear placeholder in case of error
                            avatarPlaceholder.appendChild(fallbackAvatar);
                        };
                        avatarPlaceholder.appendChild(avatarImg);
                    } else {
                        avatarPlaceholder.appendChild(fallbackAvatar);
                    }
                } else {
                    avatarPlaceholder.innerHTML = `<div class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 flex items-center justify-center text-gray-400 text-xs" title="Sem responsável"><i class="fas fa-user"></i></div>`;
                }
            }
            
            card.addEventListener('click', (e) => { e.stopPropagation(); showClientModal(client.ID_Cliente); });
            
            const quickCompleteContainer = card.querySelector('.group[data-task-id]');
            if (quickCompleteContainer) {
                if (window.innerWidth >= 768) {
                    quickCompleteContainer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleToggleTask(e.currentTarget.dataset.taskId, true);
                        showToast('Tarefa concluída!');
                    });
                }
            }
            return card;
        }

        // --- UPGRADE: LÓGICA DA NOVA VISÃO DE LISTA ---
        function setupViewToggle() {
            viewToggleButton.addEventListener('click', () => {
                if (currentView === 'kanban') {
                    currentView = 'list';
                    kanbanBoard.classList.add('hidden');
                    listView.classList.remove('hidden');
                    viewToggleIcon.className = 'fas fa-table-columns text-lg';
                    viewToggleButton.title = 'Alternar para Visão Kanban';
                    populateListViewFilters();
                    renderListView();
                } else {
                    currentView = 'kanban';
                    listView.classList.add('hidden');
                    kanbanBoard.classList.remove('hidden');
                    viewToggleIcon.className = 'fas fa-list-check text-lg';
                    viewToggleButton.title = 'Alternar para Visão de Lista';
                    applyFiltersAndRender();
                }
            });
        }

        function populateListViewFilters() {
            const responsibleFilter = document.getElementById('list-filter-responsible');
            // Impede a duplicação das opções
            if (responsibleFilter.options.length > 1) return;

            responsibleFilter.innerHTML = '<option value="all">Todos os Responsáveis</option>';
            if (appData.users) {
                appData.users.sort((a,b) => a.NomeUsuario.localeCompare(b.NomeUsuario)).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.ID_Usuario;
                    option.textContent = user.NomeUsuario;
                    responsibleFilter.appendChild(option);
                });
            }
            // Adiciona listeners uma única vez
            document.getElementById('list-filter-type').addEventListener('change', (e) => {
                listFilterType = e.target.value;
                renderListView();
            });
            document.getElementById('list-filter-responsible').addEventListener('change', (e) => {
                listFilterResponsibleId = e.target.value;
                renderListView();
            });
        }

        function renderListView() {
            const container = document.getElementById('list-view-container');
            container.innerHTML = loaderTemplate.content.cloneNode(true).firstElementChild.outerHTML;

            // 1. Obter todas as tarefas e tickets abertos
            const openTasks = (appData.tasks || []).filter(t => !t.Concluido).map(t => ({...t, type: 'task', id: t.ID_Tarefa, title: t.TituloTarefa }));
            const openTickets = (appData.tickets || []).filter(t => !t.Concluido).map(t => ({...t, type: 'ticket', id: t.ID_Ticket, title: t.TituloTicket }));
            let combinedList = [...openTasks, ...openTickets];

            // 2. Aplicar filtros globais (empresa e tag)
            const visibleClientIds = getFilteredClients().map(c => c.ID_Cliente);
            combinedList = combinedList.filter(item => visibleClientIds.includes(item.ID_Cliente));

            // 3. Aplicar filtros da lista (tipo e responsável)
            if (listFilterType !== 'all') {
                combinedList = combinedList.filter(item => item.type === listFilterType);
            }
            if (listFilterResponsibleId !== 'all') {
                combinedList = combinedList.filter(item => item.Responsavel_ID === listFilterResponsibleId);
            }

            // 4. Ordenar a lista
            combinedList.sort((a, b) => {
                const aHasDate = !!a.PrazoFinal;
                const bHasDate = !!b.PrazoFinal;
                if (!aHasDate && bHasDate) return -1; // 'a' (sem data) vem primeiro
                if (aHasDate && !bHasDate) return 1;  // 'b' (sem data) vem primeiro
                if (!aHasDate && !bHasDate) return 0; // ambos sem data, mantém a ordem
                return new Date(a.PrazoFinal) - new Date(b.PrazoFinal); // ambos com data, ordena pela mais próxima
            });

            // 5. Renderizar o HTML
            if (combinedList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-8 p-4">Nenhuma atividade encontrada com os filtros atuais.</div>';
                return;
            }

            const listHtml = combinedList.map(item => {
                const client = appData.clients.find(c => c.ID_Cliente === item.ID_Cliente);
                const responsibleUser = appData.users.find(u => u.ID_Usuario === item.Responsavel_ID);
                const timeInfo = formatTimeRemaining(item.PrazoFinal);

                let avatarHtml = `<div title="Sem responsável" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-400"><i class="fas fa-user"></i></div>`;
                if (responsibleUser) {
                    if (responsibleUser.FotoURL) {
                        avatarHtml = `<img src="${responsibleUser.FotoURL}" alt="${responsibleUser.NomeUsuario}" title="${responsibleUser.NomeUsuario}" crossorigin="anonymous" referrerpolicy="no-referrer" class="w-8 h-8 rounded-full object-cover">`;
                    } else {
                        const initial = responsibleUser.NomeUsuario ? responsibleUser.NomeUsuario.charAt(0).toUpperCase() : '?';
                        avatarHtml = `<div title="${responsibleUser.NomeUsuario}" class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold">${initial}</div>`;
                    }
                }

                const iconClass = item.type === 'task' ? 'fa-check-square text-blue-500' : 'fa-ticket text-orange-500';
                const itemTypeLabel = item.type === 'task' ? 'Tarefa' : 'Ticket';
                const dueDateTitle = item.PrazoFinal ? new Date(item.PrazoFinal).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Sem prazo definido';

                return `
                    <div class="list-item-row group bg-white rounded-lg p-3 mb-2 shadow-sm border flex items-center gap-4 relative">
                        <!-- Ícone do Tipo -->
                        <div class="flex-shrink-0 w-8 text-center" title="${itemTypeLabel}">
                            <i class="fas ${iconClass} text-xl"></i>
                        </div>
                        <!-- Informação Principal (Título e Empresa) -->
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold text-gray-800 truncate" title="${item.title}">${item.title}</p>
                            <p class="text-sm text-gray-500 truncate" title="${client ? client.NomeEmpresa : 'Cliente não encontrado'}">
                                <i class="far fa-building mr-1"></i> ${client ? client.NomeEmpresa : 'N/A'}
                            </p>
                        </div>
                        <!-- Prazo -->
                        <div class="flex-shrink-0 text-right w-32 hidden md:block">
                            <p class="text-sm font-medium ${timeInfo.colorClass} ${timeInfo.pulse ? 'pulse-animation' : ''}" title="Prazo: ${dueDateTitle}">
                                ${timeInfo.text}
                            </p>
                        </div>
                        <!-- Responsável -->
                        <div class="flex-shrink-0">
                            ${avatarHtml}
                        </div>
                        <!-- Botões de Ação (Aparecem no Hover) -->
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 h-full items-center bg-white/50 backdrop-blur-sm pl-4
                                    opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                            <button onclick="handleQuickComplete(event, '${item.type}', '${item.id}')" title="Marcar como Concluída"
                                    class="w-9 h-9 flex items-center justify-center rounded-full text-green-600 hover:bg-green-100 transition-colors">
                                <i class="fas fa-check-circle text-xl"></i>
                            </button>
                            <button onclick="openItemEditorModal(event, '${item.type}', '${item.id}')" title="Editar"
                                    class="w-9 h-9 flex items-center justify-center rounded-full text-blue-600 hover:bg-blue-100 transition-colors">
                                <i class="fas fa-pencil-alt text-md"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = listHtml;
        }
        
        // NOVA FUNÇÃO: Marca um item como concluído diretamente da lista
        function handleQuickComplete(event, itemType, itemId) {
            event.stopPropagation();
            let item, url;

            if (itemType === 'task') {
                item = appData.tasks.find(t => t.ID_Tarefa === itemId);
                url = `${SCRIPT_URL}?action=updateTask&ID_Tarefa=${itemId}&Concluido=true`;
            } else {
                item = appData.tickets.find(t => t.ID_Ticket === itemId);
                url = `${SCRIPT_URL}?action=updateTicket&ID_Ticket=${itemId}&Concluido=true`;
            }

            if (!item) return;

            const originalState = item.Concluido;
            item.Concluido = true; // Atualização otimista
            renderListView(); // Re-renderiza a lista (o item sumirá)
            showToast(`${itemTypeLabel(itemType)} concluída!`);

            jsonpRequest(url, (err, data) => {
                if (err || !data.success) {
                    showToast(`Erro ao concluir ${itemTypeLabel(itemType)}.`);
                    item.Concluido = originalState; // Reverte em caso de erro
                    renderListView(); // Re-renderiza para mostrar o item novamente
                }
            });
        }

        function itemTypeLabel(type) {
            return type === 'task' ? 'Tarefa' : 'Ticket';
        }


        // --- Lógica do PWA ---
        document.addEventListener('DOMContentLoaded', () => {
            const manifest = {
                "name": "Prisme Sales - CRM", "short_name": "Prisme CRM", "start_url": ".", "display": "standalone",
                "background_color": "#f8fafc", "theme_color": "#2fc36a", "description": "Um CRM simples e poderoso para gestão de clientes.",
                "icons": [{"src": "https://nattanlima.github.io/meu-crm-pwa/icons/icon-192-192.png", "sizes": "192x192", "type": "image/png"},
                          {"src": "https://nattanlima.github.io/meu-crm-pwa/icons/icon-512-512.png", "sizes": "512x512", "type": "image/png"}]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest').setAttribute('href', manifestUrl);

            if ('serviceWorker' in navigator) {
                const swContent = `const CACHE_NAME = 'prisme-crm-cache-v1'; const urlsToCache = ['.', 'https://cdn.tailwindcss.com', 'https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css', 'https://cdn.quilljs.com/1.3.6/quill.snow.css', 'https://cdn.quilljs.com/1.3.6/quill.min.js', 'https://crm.prismeapp.com.br/web/binary/company_logo']; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache)))); self.addEventListener('fetch', e => { if (e.request.url.startsWith('https://script.google.com')) return fetch(e.request); e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))); });`;
                const swBlob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl).then(reg => console.log('ServiceWorker registrado:', reg.scope)).catch(err => console.log('Falha no registro do ServiceWorker:', err));
                });
            }

            const savedUser = localStorage.getItem('crmUser');
            if (savedUser) { currentUser = JSON.parse(savedUser); showApp(true); } else { showLogin(); }
            clientModal.addEventListener('click', (e) => { if (e.target === clientModal) hideClientModal(); });
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape') {
                    if (!document.getElementById('item-editor-modal').classList.contains('hidden')) {
                        closeItemEditorModal();
                    } else if (!clientModal.classList.contains('hidden')) {
                        hideClientModal();
                    }
                }
            });
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            const installButtonLogin = document.getElementById('install-pwa-login-button');
            const installButtonHeader = document.getElementById('install-pwa-header-button');
            const showInstallButtons = () => { if (installButtonLogin) installButtonLogin.classList.remove('hidden'); if (installButtonHeader) installButtonHeader.classList.remove('hidden'); };
            const installHandler = () => {
                if (installButtonLogin) installButtonLogin.classList.add('hidden'); if (installButtonHeader) installButtonHeader.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log(choiceResult.outcome === 'accepted' ? 'Usuário instalou o PWA' : 'Usuário recusou a instalação do PWA');
                    deferredPrompt = null;
                });
            };
            showInstallButtons();
            if (installButtonLogin) installButtonLogin.addEventListener('click', installHandler);
            if (installButtonHeader) installButtonHeader.addEventListener('click', installHandler);
        });
        
        // --- FUNÇÕES DE LÓGICA (MODAL, TAREFAS, TICKETS, ETC.) ---
        
        function calculateProgress(clientId) {
            const tasks = appData.tasks ? appData.tasks.filter(p => p.ID_Cliente === clientId) : [];
            if (tasks.length === 0) return 0;
            const completedTasks = tasks.filter(p => p.Concluido).length;
            return Math.round((completedTasks / tasks.length) * 100);
        }

        function initializeDragAndDrop() {
            document.querySelectorAll('.kanban-cards').forEach(column => {
                new Sortable(column, {
                    group: 'kanban', animation: 150, delay: 200, delayOnTouchOnly: true, 
                    onEnd: (evt) => {
                        const { item, to, from } = evt; const clientId = item.dataset.clientId; const newStatus = to.dataset.statusName;
                        const client = appData.clients.find(c => c.ID_Cliente.toString() === clientId); if (client) { client.Status = newStatus; }
                        const updateUrl = `${SCRIPT_URL}?action=updateClientStatus&clientId=${encodeURIComponent(clientId)}&newStatus=${encodeURIComponent(newStatus)}`;
                        jsonpRequest(updateUrl, (err, data) => {
                            if (err || !data.success) {
                                showToast('Erro ao atualizar status.');
                                const client = appData.clients.find(c => c.ID_Cliente.toString() === clientId); if (client) { client.Status = from.dataset.statusName; }
                                from.appendChild(item);
                            }
                            updateColumnHeaders();
                        });
                    }
                });
            });
        }

        function showClientModal(clientId, onReadyCallback = null) {
            const client = appData.clients.find(c => c.ID_Cliente === clientId); if (!client) return;
            const uncompletedTasksCount = appData.tasks ? appData.tasks.filter(t => t.ID_Cliente === clientId && !t.Concluido).length : 0;
            const uncompletedTicketsCount = appData.tickets ? appData.tickets.filter(t => t.ID_Cliente === clientId && !t.Concluido).length : 0;
            const tasksBadgeHtml = uncompletedTasksCount > 0 ? `<span class="tab-badge">${uncompletedTasksCount}</span>` : '';
            const ticketsBadgeHtml = uncompletedTicketsCount > 0 ? `<span class="tab-badge">${uncompletedTicketsCount}</span>` : '';
            modalContent.innerHTML = ''; modalContent.appendChild(loaderTemplate.content.cloneNode(true));
            clientModal.classList.remove('hidden'); 
            
            requestAnimationFrame(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            });

            modalContent.innerHTML = `<div class="p-6 border-b flex-shrink-0"><div class="flex justify-between items-start"><div><h2 class="text-3xl font-bold text-gray-800">${client.NomeEmpresa}</h2></div><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div></div><div class="border-b border-gray-200 flex-shrink-0"><nav id="modal-tabs" class="flex space-x-4 px-6 -mb-px overflow-x-auto"><button data-tab="details" class="tab-button active flex-shrink-0">Detalhes</button><button data-tab="tasks" class="tab-button flex-shrink-0 flex items-center">Tarefas ${tasksBadgeHtml}</button><button data-tab="tickets" class="tab-button flex-shrink-0 flex items-center">Tickets ${ticketsBadgeHtml}</button></nav></div><div class="p-6 overflow-y-auto flex-grow"><div id="tab-content-details" class="tab-content active"><div id="modal-form" data-client-id="${clientId}"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><div><label class="text-sm font-medium text-gray-700">Nome da Empresa</label><input type="text" id="modal-NomeEmpresa" value="${client.NomeEmpresa || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">CNPJ</label><input type="text" id="modal-CNPJ" value="${client.CNPJ || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">Nome do Responsável</label><input type="text" id="modal-NomeResponsavel" value="${client.NomeResponsavel || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">WhatsApp</label><input type="text" id="modal-WhatsApp" value="${client.WhatsApp || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">E-mail Financeiro</label><input type="text" id="modal-EmailFinanceiro" value="${client.EmailFinanceiro || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">Telefone do Dono</label><input type="text" id="modal-TelefoneDono" value="${client.TelefoneDono || ''}" class="form-input"></div><div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Link do Grupo WhatsApp</label><input type="text" id="modal-LinkGrupoWhatsApp" value="${client.LinkGrupoWhatsApp || ''}" class="form-input"></div><div><label class="text-sm font-medium text-gray-700">Valor do Contrato</label><input type="text" id="modal-ValorContrato" value="${client.ValorContrato || ''}" class="form-input" placeholder="R$ 0,00"></div><div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Anotações</label><textarea id="modal-Anotacoes" rows="4" class="form-input">${client.Anotacoes || ''}</textarea></div></div><div class="mt-8 pt-5 border-t flex justify-end items-center gap-3"><span id="save-status" class="text-sm text-green-600"></span><button id="save-client-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full flex items-center"><i class="fas fa-save mr-2"></i>Salvar Alterações</button></div></div></div><div id="tab-content-tasks" class="tab-content"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-gray-600">Tarefas do Projeto</h4><button id="add-main-task-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white text-sm font-bold py-1 px-3 rounded-full flex items-center"><i class="fas fa-plus mr-2"></i>Nova Tarefa</button></div><div id="task-list-container" class="bg-slate-50 p-4 rounded-lg"></div><div id="task-editor-container" class="mt-4 border-t pt-4 hidden"></div></div><div id="tab-content-tickets" class="tab-content"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-gray-600">Tickets/Chamados</h4><button id="add-main-ticket-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white text-sm font-bold py-1 px-3 rounded-full flex items-center"><i class="fas fa-plus mr-2"></i>Novo Ticket</button></div><div id="ticket-list-container" class="bg-slate-50 p-4 rounded-lg"></div><div id="ticket-editor-container" class="mt-4 border-t pt-4 hidden"></div></div></div>`;
            const tabs = document.querySelectorAll('.tab-button'); const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); contents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(`tab-content-${tab.dataset.tab}`).classList.add('active'); }); });
            renderTaskList(clientId); renderTicketList(clientId);
            document.getElementById('close-modal-btn').addEventListener('click', hideClientModal);
            document.getElementById('save-client-btn').addEventListener('click', () => handleSaveClient(clientId));
            document.getElementById('add-main-task-btn').addEventListener('click', () => showNewTaskForm(clientId, '0'));
            document.getElementById('add-main-ticket-btn').addEventListener('click', () => showNewTicketForm(clientId, '0'));
            
            if (onReadyCallback) {
                requestAnimationFrame(onReadyCallback);
            }
        }

        function hideClientModal() {
            const form = modalContent.querySelector('#modal-form');
            if (form) {
                const clientId = form.dataset.clientId;
                const client = appData.clients.find(c => c.ID_Cliente.toString() === clientId);
                if (client) {
                    updateCardOnBoard(client.ID_Cliente);
                }
            }
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                clientModal.classList.add('hidden');
                if (currentView === 'list') {
                    renderListView();
                }
            }, 300);
        }
        
        function updateCardOnBoard(clientId) {
            const cardElement = document.querySelector(`.kanban-card[data-client-id="${clientId}"]`);
            if (cardElement) {
                const client = appData.clients.find(c => c.ID_Cliente === clientId);
                if (client) {
                    const newCard = createClientCard(client);
                    cardElement.replaceWith(newCard);
                }
            }
        }
        
        function updateColumnHeaders() {
            const clientList = getFilteredClients();
            appData.statuses.forEach(status => {
                const column = kanbanBoard.querySelector(`[data-status-name="${status.NomeStatus}"]`)?.closest('.kanban-column');
                if (column) {
                    const clientsInStatus = clientList.filter(c => c.Status === status.NomeStatus);
                    const count = clientsInStatus.length;
                    
                    const expandedCountEl = column.querySelector('.column-header-expanded .ml-2');
                    if (expandedCountEl) expandedCountEl.textContent = count;

                    const collapsedCountEl = column.querySelector('.column-header-collapsed .rounded-full');
                    if (collapsedCountEl) collapsedCountEl.textContent = count;
                }
            });
        }

        function renderTaskList(clientId) {
            const container = document.getElementById('task-list-container'); const clientTasks = appData.tasks ? appData.tasks.filter(t => t.ID_Cliente === clientId) : [];
            function buildTaskTree(parentId) {
                const tasks = clientTasks.filter(task => { if (parentId === '0') return task.Parent_ID_Tarefa == '0' || !task.Parent_ID_Tarefa; return task.Parent_ID_Tarefa === parentId; });
                if (tasks.length === 0) return ''; let html = `<div class="${parentId !== '0' ? 'ml-6 border-l-2 border-gray-200 pl-4' : ''}">`;
                tasks.sort((a,b) => a.Ordem - b.Ordem).forEach(task => {
                    const responsibleUser = appData.users.find(u => u.ID_Usuario === task.Responsavel_ID); const dueDate = task.PrazoFinal ? new Date(task.PrazoFinal) : null; const today = new Date(); today.setHours(0,0,0,0); const isOverdue = dueDate && dueDate < today;
                    html += `<div class="task-item group flex items-center justify-between p-2 hover:bg-gray-100 rounded-md"><div class="flex items-center flex-grow min-w-0"><input type="checkbox" data-task-id="${task.ID_Tarefa}" class="task-checkbox h-4 w-4 mr-3 flex-shrink-0" ${task.Concluido ? 'checked' : ''}><div class="truncate"><span class="task-title ${task.Concluido ? 'line-through text-gray-400' : ''}">${task.TituloTarefa}</span>${dueDate ? `<span class="ml-2 text-xs ${isOverdue ? 'text-red-500' : 'text-gray-500'}"><i class="far fa-calendar-alt mr-1"></i>${dueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}</div>${responsibleUser ? `<span class="ml-2 text-xs text-gray-500 bg-gray-200 rounded-full px-2 py-0.5 flex-shrink-0">${responsibleUser.NomeUsuario}</span>` : ''}</div><div class="task-controls opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"><button title="Adicionar Subtarefa" class="add-subtask-btn text-gray-400 hover:text-green-500 p-1" data-parent-id="${task.ID_Tarefa}"><i class="fas fa-plus-circle"></i></button><button title="Editar Tarefa" class="edit-task-btn text-gray-400 hover:text-blue-500 p-1" data-task-id="${task.ID_Tarefa}"><i class="fas fa-pencil-alt"></i></button><button title="Apagar Tarefa" class="delete-task-btn text-gray-400 hover:text-red-500 p-1" data-task-id="${task.ID_Tarefa}"><i class="fas fa-trash"></i></button></div></div>`;
                    html += buildTaskTree(task.ID_Tarefa);
                }); html += `</div>`; return html;
            }
            container.innerHTML = buildTaskTree('0') || '<p class="text-gray-500">Nenhuma tarefa criada para este cliente.</p>';
            container.querySelectorAll('.task-checkbox').forEach(cb => cb.addEventListener('change', (e) => handleToggleTask(e.target.dataset.taskId, e.target.checked)));
            container.querySelectorAll('.add-subtask-btn').forEach(btn => btn.addEventListener('click', (e) => showNewTaskForm(clientId, e.currentTarget.dataset.parentId)));
            container.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', (e) => showTaskEditor(e.currentTarget.dataset.taskId)));
            container.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteTask(e.currentTarget.dataset.taskId)));
        }

        function showTaskEditor(taskId) {
            const editorContainer = document.getElementById('task-editor-container'); const task = appData.tasks.find(t => t.ID_Tarefa === taskId); if (!task) return;
            const userOptions = appData.users.map(user => `<option value="${user.ID_Usuario}" ${task.Responsavel_ID === user.ID_Usuario ? 'selected' : ''}>${user.NomeUsuario}</option>`).join('');
            const dueDateValue = task.PrazoFinal ? new Date(task.PrazoFinal).toISOString().split('T')[0] : '';
            editorContainer.innerHTML = `<h5 class="font-bold text-lg mb-2">Editando Tarefa</h5><input type="text" id="editor-task-title" value="${task.TituloTarefa}" class="form-input w-full mb-2 text-lg font-semibold" placeholder="Título da Tarefa"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="text-sm font-medium text-gray-700">Responsável</label><select id="editor-task-responsible" class="form-input"><option value="">Ninguém</option>${userOptions}</select></div><div><label class="text-sm font-medium text-gray-700">Prazo Final</label><input type="date" id="editor-task-due-date" value="${dueDateValue}" class="form-input"><div class="flex space-x-2 mt-2"><button class="suggestion-btn" data-days="3">+3 dias</button><button class="suggestion-btn" data-days="7">+7 dias</button></div></div></div><div class="mt-4" id="quill-editor-task"></div><div class="flex justify-end mt-2"><button id="save-task-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">Salvar Tarefa</button></div>`;
            editorContainer.classList.remove('hidden'); quillEditor = new Quill('#quill-editor-task', { theme: 'snow' }); if (task.DescricaoDetalhada) quillEditor.root.innerHTML = task.DescricaoDetalhada;
            editorContainer.querySelectorAll('.suggestion-btn').forEach(btn => { btn.addEventListener('click', () => { const daysToAdd = parseInt(btn.dataset.days); const dateInput = document.getElementById('editor-task-due-date'); const newDate = new Date(); newDate.setDate(newDate.getDate() + daysToAdd); dateInput.value = newDate.toISOString().split('T')[0]; }); });
            document.getElementById('save-task-btn').addEventListener('click', () => handleSaveTask(taskId));
        }

        function handleSaveTask(taskId) {
            const title = document.getElementById('editor-task-title').value; const description = quillEditor.root.innerHTML; const responsibleId = document.getElementById('editor-task-responsible').value; const dueDate = document.getElementById('editor-task-due-date').value;
            const task = appData.tasks.find(t => t.ID_Tarefa === taskId); const client = appData.clients.find(c => c.ID_Cliente === task.ID_Cliente);
            task.TituloTarefa = title; task.DescricaoDetalhada = description; task.Responsavel_ID = responsibleId; task.PrazoFinal = dueDate;
            showClientModal(client.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
            const url = `${SCRIPT_URL}?action=updateTask&ID_Tarefa=${taskId}&TituloTarefa=${encodeURIComponent(title)}&DescricaoDetalhada=${encodeURIComponent(description)}&Responsavel_ID=${encodeURIComponent(responsibleId)}&PrazoFinal=${encodeURIComponent(dueDate)}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao salvar a tarefa."); initializeApp(); } });
        }

        function showNewTaskForm(clientId, parentId) {
            if (document.getElementById('new-task-form')) return;
            const targetContainer = parentId !== '0' ? document.querySelector(`.add-subtask-btn[data-parent-id="${parentId}"]`).closest('.task-item').parentNode : document.getElementById('task-list-container');
            const formHtml = `<form id="new-task-form" class="p-2"><input type="text" id="new-task-input" class="form-input w-full" placeholder="Escreva o título e prima Enter"></form>`;
            targetContainer.insertAdjacentHTML(parentId !== '0' ? 'beforeend' : 'afterbegin', formHtml);
            const form = document.getElementById('new-task-form'); const input = document.getElementById('new-task-input'); input.focus();
            form.addEventListener('submit', (e) => { e.preventDefault(); const title = input.value.trim(); if (title) { handleCreateTask(clientId, parentId, title); } form.remove(); });
            input.addEventListener('blur', () => { setTimeout(() => { if (document.getElementById('new-task-form')) document.getElementById('new-task-form').remove(); }, 150); });
        }

        function handleCreateTask(clientId, parentId, title) {
            let url = `${SCRIPT_URL}?action=createTask&ID_Cliente=${clientId}&TituloTarefa=${encodeURIComponent(title)}`; if (parentId && parentId !== '0') url += `&Parent_ID_Tarefa=${parentId}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao criar a tarefa."); } else { appData.tasks.push(data.newTask); showClientModal(clientId); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50); } });
        }

        function handleToggleTask(taskId, isCompleted) {
            const task = appData.tasks.find(t => t.ID_Tarefa === taskId); const originalState = task.Concluido; task.Concluido = isCompleted;
            showClientModal(task.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
            const url = `${SCRIPT_URL}?action=updateTask&ID_Tarefa=${taskId}&Concluido=${isCompleted}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao atualizar o status da tarefa."); task.Concluido = originalState; showClientModal(task.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50); } });
        }

        function handleDeleteTask(taskId) {
            showConfirmationModal("Tem a certeza de que quer apagar esta tarefa e todas as suas subtarefas?", () => {
                const task = appData.tasks.find(t => t.ID_Tarefa === taskId); const originalTasks = [...appData.tasks];
                const tasksToRemove = [taskId]; let i = 0;
                while (i < tasksToRemove.length) { const parentId = tasksToRemove[i]; appData.tasks.filter(t => t.Parent_ID_Tarefa === parentId).forEach(child => tasksToRemove.push(child.ID_Tarefa)); i++; }
                appData.tasks = appData.tasks.filter(t => !tasksToRemove.includes(t.ID_Tarefa));
                showClientModal(task.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
                const url = `${SCRIPT_URL}?action=deleteTask&ID_Tarefa=${taskId}`;
                jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao apagar a tarefa."); appData.tasks = originalTasks; showClientModal(task.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50); } });
            });
        }

        // --- Lógica de Tickets ---
        function renderTicketList(clientId) {
            const container = document.getElementById('ticket-list-container'); const allClientTickets = appData.tickets ? appData.tickets.filter(t => t.ID_Cliente === clientId) : [];
            const generateTicketItemHtml = (ticket) => {
                const responsibleUser = appData.users.find(u => u.ID_Usuario === ticket.Responsavel_ID); const dueDate = ticket.PrazoFinal ? new Date(ticket.PrazoFinal) : null; const today = new Date(); today.setHours(0, 0, 0, 0); const isOverdue = dueDate && dueDate < today && !ticket.Concluido;
                return `<div class="task-item group flex items-center justify-between p-2 hover:bg-gray-100 rounded-md"><div class="flex items-center flex-grow min-w-0"><input type="checkbox" data-ticket-id="${ticket.ID_Ticket}" class="ticket-checkbox h-4 w-4 mr-3 flex-shrink-0" ${ticket.Concluido ? 'checked' : ''}><div class="truncate"><span class="ticket-title ${ticket.Concluido ? 'line-through text-gray-400' : ''}">${ticket.TituloTicket}</span>${dueDate ? `<span class="ml-2 text-xs ${isOverdue ? 'text-red-500 font-semibold' : 'text-gray-500'}"><i class="far fa-calendar-alt mr-1"></i>${dueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}</div>${responsibleUser ? `<span class="ml-2 text-xs text-gray-500 bg-gray-200 rounded-full px-2 py-0.5 flex-shrink-0">${responsibleUser.NomeUsuario}</span>` : ''}</div><div class="task-controls opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"><button title="Adicionar Sub-ticket" class="add-subticket-btn text-gray-400 hover:text-green-500 p-1" data-parent-id="${ticket.ID_Ticket}"><i class="fas fa-plus-circle"></i></button><button title="Editar Ticket" class="edit-ticket-btn text-gray-400 hover:text-blue-500 p-1" data-ticket-id="${ticket.ID_Ticket}"><i class="fas fa-pencil-alt"></i></button><button title="Apagar Ticket" class="delete-ticket-btn text-gray-400 hover:text-red-500 p-1" data-ticket-id="${ticket.ID_Ticket}"><i class="fas fa-trash"></i></button></div></div>`;
            };
            function buildTicketHtmlRecursive(parentId) {
                let ticketsForLevel = allClientTickets.filter(ticket => { if (parentId === '0') return ticket.Parent_ID_Ticket == '0' || !ticket.Parent_ID_Ticket; return ticket.Parent_ID_Ticket === parentId; });
                if (ticketsForLevel.length === 0) return ''; let separatorHtml = '';
                if (parentId === '0') {
                    const uncompleted = ticketsForLevel.filter(t => !t.Concluido); const completed = ticketsForLevel.filter(t => t.Concluido);
                    uncompleted.sort((a, b) => { const dateA = a.PrazoFinal ? new Date(a.PrazoFinal) : null; const dateB = b.PrazoFinal ? new Date(b.PrazoFinal) : null; if (dateA && dateB) return dateA - dateB; if (dateA) return -1; if (dateB) return 1; return 0; });
                    ticketsForLevel = [...uncompleted, ...completed];
                    if (uncompleted.length > 0 && completed.length > 0) { separatorHtml = `<div class="mt-4 pt-4 border-t border-gray-300"><h5 class="px-2 mb-2 text-sm font-semibold text-gray-500 uppercase">Concluídos</h5></div>`; }
                } else { ticketsForLevel.sort((a, b) => a.Ordem - b.Ordem); }
                let html = `<div class="${parentId !== '0' ? 'ml-6 border-l-2 border-gray-200 pl-4' : ''}">`; let uncompletedProcessed = false;
                ticketsForLevel.forEach((ticket) => { if (parentId === '0' && separatorHtml && ticket.Concluido && !uncompletedProcessed) { html += separatorHtml; uncompletedProcessed = true; } html += generateTicketItemHtml(ticket); html += buildTicketHtmlRecursive(ticket.ID_Ticket); });
                html += `</div>`; return html;
            }
            container.innerHTML = buildTicketHtmlRecursive('0') || '<p class="text-gray-500">Nenhum ticket criado para este cliente.</p>';
            container.querySelectorAll('.ticket-checkbox').forEach(cb => cb.addEventListener('change', (e) => handleToggleTicket(e.target.dataset.ticketId, e.target.checked)));
            container.querySelectorAll('.add-subticket-btn').forEach(btn => btn.addEventListener('click', (e) => showNewTicketForm(clientId, e.currentTarget.dataset.parentId)));
            container.querySelectorAll('.edit-ticket-btn').forEach(btn => btn.addEventListener('click', (e) => showTicketEditor(e.currentTarget.dataset.ticketId)));
            container.querySelectorAll('.delete-ticket-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteTicket(e.currentTarget.dataset.ticketId)));
        }

        function showTicketEditor(ticketId) {
            const editorContainer = document.getElementById('ticket-editor-container'); const ticket = appData.tickets.find(t => t.ID_Ticket === ticketId); if (!ticket) return;
            const userOptions = appData.users.map(user => `<option value="${user.ID_Usuario}" ${ticket.Responsavel_ID === user.ID_Usuario ? 'selected' : ''}>${user.NomeUsuario}</option>`).join('');
            const dueDateValue = ticket.PrazoFinal ? new Date(ticket.PrazoFinal).toISOString().split('T')[0] : '';
            editorContainer.innerHTML = `<h5 class="font-bold text-lg mb-2">Editando Ticket</h5><input type="text" id="editor-ticket-title" value="${ticket.TituloTicket}" class="form-input w-full mb-2 text-lg font-semibold" placeholder="Título do Ticket"><div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-medium text-gray-700">Responsável</label><select id="editor-ticket-responsible" class="form-input"><option value="">Ninguém</option>${userOptions}</select></div><div><label class="text-sm font-medium text-gray-700">Prazo Final</label><input type="date" id="editor-ticket-due-date" value="${dueDateValue}" class="form-input"><div class="flex space-x-2 mt-2"> <button class="suggestion-btn" data-days="3">+3 dias</button> <button class="suggestion-btn" data-days="7">+7 dias</button> </div></div></div><div class="mt-4" id="quill-editor-ticket"></div><div class="flex justify-end mt-2"> <button id="save-ticket-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">Salvar Ticket</button> </div>`;
            editorContainer.classList.remove('hidden'); quillEditor = new Quill('#quill-editor-ticket', { theme: 'snow' }); if (ticket.DescricaoDetalhada) quillEditor.root.innerHTML = ticket.DescricaoDetalhada;
            editorContainer.querySelectorAll('.suggestion-btn').forEach(btn => { btn.addEventListener('click', () => { const daysToAdd = parseInt(btn.dataset.days); const dateInput = document.getElementById('editor-ticket-due-date'); const newDate = new Date(); newDate.setDate(newDate.getDate() + daysToAdd); dateInput.value = newDate.toISOString().split('T')[0]; }); });
            document.getElementById('save-ticket-btn').addEventListener('click', () => handleSaveTicket(ticketId));
        }

        function handleSaveTicket(ticketId) {
            const title = document.getElementById('editor-ticket-title').value; const description = quillEditor.root.innerHTML; const responsibleId = document.getElementById('editor-ticket-responsible').value; const dueDate = document.getElementById('editor-ticket-due-date').value;
            const ticket = appData.tickets.find(t => t.ID_Ticket === ticketId); const client = appData.clients.find(c => c.ID_Cliente === ticket.ID_Cliente);
            ticket.TituloTicket = title; ticket.DescricaoDetalhada = description; ticket.Responsavel_ID = responsibleId; ticket.PrazoFinal = dueDate;
            showClientModal(client.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
            const url = `${SCRIPT_URL}?action=updateTicket&ID_Ticket=${ticketId}&TituloTicket=${encodeURIComponent(title)}&DescricaoDetalhada=${encodeURIComponent(description)}&Responsavel_ID=${encodeURIComponent(responsibleId)}&PrazoFinal=${encodeURIComponent(dueDate)}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao salvar o ticket."); initializeApp(); } });
        }

        function showNewTicketForm(clientId, parentId) {
            if (document.getElementById('new-ticket-form')) return;
            const targetContainer = parentId !== '0' ? document.querySelector(`.add-subticket-btn[data-parent-id="${parentId}"]`).closest('.task-item').parentNode : document.getElementById('ticket-list-container');
            const formHtml = `<form id="new-ticket-form" class="p-2"><input type="text" id="new-ticket-input" class="form-input w-full" placeholder="Escreva o título e prima Enter"></form>`;
            targetContainer.insertAdjacentHTML(parentId !== '0' ? 'beforeend' : 'afterbegin', formHtml);
            const form = document.getElementById('new-ticket-form'); const input = document.getElementById('new-ticket-input'); input.focus();
            form.addEventListener('submit', (e) => { e.preventDefault(); const title = input.value.trim(); if (title) { handleCreateTicket(clientId, parentId, title); } form.remove(); });
            input.addEventListener('blur', () => { setTimeout(() => { if (document.getElementById('new-ticket-form')) document.getElementById('new-ticket-form').remove(); }, 150); });
        }

        function handleCreateTicket(clientId, parentId, title) {
            let url = `${SCRIPT_URL}?action=createTicket&ID_Cliente=${clientId}&TituloTicket=${encodeURIComponent(title)}`; if (parentId && parentId !== '0') url += `&Parent_ID_Ticket=${parentId}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao criar o ticket."); } else { appData.tickets.push(data.newTicket); showClientModal(clientId); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50); } });
        }

        function handleToggleTicket(ticketId, isCompleted) {
            const ticket = appData.tickets.find(t => t.ID_Ticket === ticketId); const originalState = ticket.Concluido; ticket.Concluido = isCompleted;
            showClientModal(ticket.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
            const url = `${SCRIPT_URL}?action=updateTicket&ID_Ticket=${ticketId}&Concluido=${isCompleted}`;
            jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao atualizar o status do ticket."); ticket.Concluido = originalState; showClientModal(ticket.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50); } });
        }

        function handleDeleteTicket(ticketId) {
            showConfirmationModal("Tem a certeza de que quer apagar este ticket e todos os seus sub-tickets?", () => {
                const ticket = appData.tickets.find(t => t.ID_Ticket === ticketId); const originalTickets = [...appData.tickets];
                const ticketsToRemove = [ticketId]; let i = 0;
                while (i < ticketsToRemove.length) { const parentId = ticketsToRemove[i]; appData.tickets.filter(t => t.Parent_ID_Ticket === parentId).forEach(child => ticketsToRemove.push(child.ID_Ticket)); i++; }
                appData.tickets = appData.tickets.filter(t => !ticketsToRemove.includes(t.ID_Ticket));
                showClientModal(ticket.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
                const url = `${SCRIPT_URL}?action=deleteTicket&ID_Ticket=${ticketId}`;
                jsonpRequest(url, (err, data) => { if (err || !data.success) { showToast("Erro ao apagar o ticket."); appData.tickets = originalTickets; showClientModal(ticket.ID_Cliente); setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50); } });
            });
        }
        
        function handleSaveClient(clientId) {
            const saveBtn = document.getElementById('save-client-btn'); const saveStatus = document.getElementById('save-status');
            saveBtn.disabled = true; saveStatus.textContent = 'Salvando...';
            const fieldsToUpdate = ['NomeEmpresa', 'CNPJ', 'NomeResponsavel', 'WhatsApp', 'EmailFinanceiro', 'TelefoneDono', 'LinkGrupoWhatsApp', 'ValorContrato', 'Anotacoes'];
            let updateUrl = `${SCRIPT_URL}?action=updateClientData&clientId=${encodeURIComponent(clientId)}`; const updatedData = {};
            fieldsToUpdate.forEach(field => { const value = document.getElementById(`modal-${field}`).value; updateUrl += `&${encodeURIComponent(field)}=${encodeURIComponent(value)}`; updatedData[field] = value; });
            jsonpRequest(updateUrl, (err, data) => {
                saveBtn.disabled = false;
                if (err || !data.success) { saveStatus.textContent = 'Erro ao salvar!'; setTimeout(() => saveStatus.textContent = '', 2000); } 
                else {
                    saveStatus.textContent = 'Salvo com sucesso!';
                    const clientInState = appData.clients.find(c => c.ID_Cliente === clientId); if (clientInState) { Object.assign(clientInState, updatedData); }
                    setTimeout(() => hideClientModal(), 1000);
                }
            });
        }

        // --- LÓGICA DO NOVO MODAL DE EDIÇÃO ---
        function openItemEditorModal(event, itemType, itemId) {
            event.stopPropagation();
            const item = itemType === 'task'
                ? appData.tasks.find(t => t.ID_Tarefa === itemId)
                : appData.tickets.find(t => t.ID_Ticket === itemId);

            if (!item) return;

            const modal = document.getElementById('item-editor-modal');
            const content = document.getElementById('item-editor-content');
            
            const userOptions = appData.users.map(user => `<option value="${user.ID_Usuario}" ${item.Responsavel_ID === user.ID_Usuario ? 'selected' : ''}>${user.NomeUsuario}</option>`).join('');
            const dueDateValue = item.PrazoFinal ? new Date(item.PrazoFinal).toISOString().split('T')[0] : '';
            const titleLabel = itemTypeLabel(itemType);
            const titleValue = itemType === 'task' ? item.TituloTarefa : item.TituloTicket;

            content.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Editar ${titleLabel}</h3>
                    <button onclick="closeItemEditorModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto flex-grow" data-item-id="${itemId}" data-item-type="${itemType}">
                    <input type="text" id="item-editor-title" value="${titleValue}" class="form-input w-full mb-4 text-lg font-semibold" placeholder="Título">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Responsável</label>
                            <select id="item-editor-responsible" class="form-input"><option value="">Ninguém</option>${userOptions}</select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                            <input type="date" id="item-editor-due-date" value="${dueDateValue}" class="form-input">
                        </div>
                    </div>
                    <div class="mt-4" id="quill-editor-item"></div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end">
                    <button id="save-item-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">Salvar Alterações</button>
                </div>
            `;

            itemQuillEditor = new Quill('#quill-editor-item', { theme: 'snow' });
            if (item.DescricaoDetalhada) {
                itemQuillEditor.root.innerHTML = item.DescricaoDetalhada;
            }

            document.getElementById('save-item-btn').addEventListener('click', saveItemFromEditor);

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
            });
        }

        function closeItemEditorModal() {
            const modal = document.getElementById('item-editor-modal');
            const content = document.getElementById('item-editor-content');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.innerHTML = '';
                itemQuillEditor = null;
            }, 300);
        }

        function saveItemFromEditor() {
            const content = document.getElementById('item-editor-content').querySelector('[data-item-id]');
            const itemId = content.dataset.itemId;
            const itemType = content.dataset.itemType;

            const title = document.getElementById('item-editor-title').value;
            const description = itemQuillEditor.root.innerHTML;
            const responsibleId = document.getElementById('item-editor-responsible').value;
            const dueDate = document.getElementById('item-editor-due-date').value;

            let item, url, idField, titleField;

            if (itemType === 'task') {
                item = appData.tasks.find(t => t.ID_Tarefa === itemId);
                idField = 'ID_Tarefa';
                titleField = 'TituloTarefa';
            } else {
                item = appData.tickets.find(t => t.ID_Ticket === itemId);
                idField = 'ID_Ticket';
                titleField = 'TituloTicket';
            }

            if (!item) return;

            // Atualiza os dados locais (otimista)
            item[titleField] = title;
            item.DescricaoDetalhada = description;
            item.Responsavel_ID = responsibleId;
            item.PrazoFinal = dueDate;

            url = `${SCRIPT_URL}?action=${itemType === 'task' ? 'updateTask' : 'updateTicket'}&${idField}=${itemId}&${titleField}=${encodeURIComponent(title)}&DescricaoDetalhada=${encodeURIComponent(description)}&Responsavel_ID=${encodeURIComponent(responsibleId)}&PrazoFinal=${encodeURIComponent(dueDate)}`;

            jsonpRequest(url, (err, data) => {
                if (err || !data.success) {
                    showToast(`Erro ao salvar ${itemTypeLabel(itemType)}.`);
                    // Idealmente, aqui deveria haver uma lógica para reverter os dados locais
                    // Mas por simplicidade, vamos apenas recarregar tudo
                    initializeApp(); 
                } else {
                    showToast(`${itemTypeLabel(itemType)} salvo com sucesso!`);
                }
            });

            closeItemEditorModal();
            renderListView();
            updateCardOnBoard(item.ID_Cliente);
        }

    </script>
</body>
</html>
